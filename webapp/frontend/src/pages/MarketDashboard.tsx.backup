import React, { useEffect, useState } from 'react';
import {
  Container,
  Typography,
  Grid,
  Box,
  Card,
  CardContent,
  CircularProgress,
  Alert,
} from '@mui/material';
import {
  Dashboard as DashboardIcon,
  TrendingUp,
  Home,
  LocationOn,
  AttachMoney,
} from '@mui/icons-material';
import Plot from 'react-plotly.js';
import { 
  apiService, 
  MarketStats, 
  DistrictInvestmentScores, 
  ChartData, 
  ActivityData 
} from '../services/api';

const MarketDashboard: React.FC = () => {
  const [marketStats, setMarketStats] = useState<MarketStats | null>(null);
  const [districtInvestmentScores, setDistrictInvestmentScores] = useState<DistrictInvestmentScores | null>(null);
  const [chartData, setChartData] = useState<{
    renovation: ChartData | null;
    buildType: ChartData | null;
    marketSegments: ChartData | null;
    sizeAnalysis: ChartData | null;
    bargainDistribution: ChartData | null;
    activityByDay: ActivityData | null;
  }>({
    renovation: null,
    buildType: null,
    marketSegments: null,
    sizeAnalysis: null,
    bargainDistribution: null,
    activityByDay: null,
  });
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      setError(null);
      try {
        const [stats, districtScores] = await Promise.all([
          apiService.getMarketStats(),
          apiService.getDistrictInvestmentScores()
        ]);
        setMarketStats(stats);
        setDistrictInvestmentScores(districtScores);

        // Fetch chart data
        try {
          const [
            renovationData,
            buildTypeData,
            marketSegmentsData,
            sizeAnalysisData,
            bargainDistributionData,
            activityByDayData
          ] = await Promise.all([
            apiService.getRenovationImpactData(),
            apiService.getBuildTypeData(),
            apiService.getMarketSegmentsData(),
            apiService.getSizeAnalysisData(),
            apiService.getBargainDistributionData(),
            apiService.getActivityByDayData()
          ]);

          setChartData({
            renovation: renovationData,
            buildType: buildTypeData,
            marketSegments: marketSegmentsData,
            sizeAnalysis: sizeAnalysisData,
            bargainDistribution: bargainDistributionData,
            activityByDay: activityByDayData,
          });
        } catch (chartErr) {
          console.error('Error fetching chart data:', chartErr);
          // Fall back to mock data if API fails
          setChartData({
            renovation: {
              labels: ['Без ремонта (коробка)', 'Новый ремонт', 'С ремонтом'],
              values: [5351, 8420, 7755],
              counts: [198, 130, 111]
            },
            buildType: {
              labels: ['Вторичный рынок', 'Новостройка'],
              values: [7780, 6516],
              counts: [122, 317]
            },
            marketSegments: {
              labels: ['Budget Market', 'Mid Market', 'Premium Market', 'Luxury Market'],
              values: [517120, 544223, 587870, 882175],
              counts: [108, 230, 23, 55]
            },
            sizeAnalysis: {
              labels: ['Compact (53m²)', 'Standard (68m²)', 'Spacious (83m²)', 'Premium (106m²)'],
              values: [8466, 8074, 6458, 6364],
              counts: [17, 100, 153, 169]
            },
            bargainDistribution: {
              labels: ['Excellent Deals', 'Good Investments', 'Fair Value', 'Market Price', 'Overpriced'],
              values: [2, 23, 185, 141, 88],
              counts: [2, 23, 185, 141, 88]
            },
            activityByDay: {
              x: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
              y: [65, 72, 85, 78, 68, 60, 45]
            },
          });
        }
      } catch (err) {
        setError('Failed to load market statistics. Please try again.');
        console.error('Error fetching market stats:', err);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  const formatPrice = (price: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'TJS',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(price);
  };

  const formatNumber = (num: number) => {
    return new Intl.NumberFormat('en-US').format(num);
  };

  // Prepare chart data
  const getPriceDistributionData = () => {
    if (!marketStats?.price_distribution) return { x: [], y: [] };
    
    const labels = Object.keys(marketStats.price_distribution);
    const values = Object.values(marketStats.price_distribution);
    
    return {
      x: labels,
      y: values,
    };
  };

  const getBestInvestmentDistrictsData = () => {
    if (!districtInvestmentScores || !districtInvestmentScores.labels.length) {
      return { labels: [], values: [] };
    }
    
    return {
      labels: districtInvestmentScores.labels,
      values: districtInvestmentScores.values,
    };
  };

  const getActivityByDayData = () => {
    if (!chartData.activityByDay) {
      return {
        x: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
        y: [0, 0, 0, 0, 0, 0, 0]
      };
    }
    return chartData.activityByDay;
  };

  const getCityDistributionData = () => {
    if (!marketStats?.city_distribution) return { labels: [], values: [] };
    
    const labels = Object.keys(marketStats.city_distribution);
    const values = labels.map(label => marketStats.city_distribution[label]);
    
    return { labels, values };
  };

  const getInvestmentData = () => {
    if (!chartData.bargainDistribution) {
      return { labels: [], values: [] };
    }
    return {
      labels: chartData.bargainDistribution.labels,
      values: chartData.bargainDistribution.values,
    };
  };

  const getRenovationImpactData = () => {
    if (!chartData.renovation) {
      return {
        labels: ['No Data'],
        values: [0],
        counts: [0]
      };
    }
    return chartData.renovation;
  };

  const getBuildTypeData = () => {
    if (!chartData.buildType) {
      return {
        labels: ['No Data'],
        values: [0],
        counts: [0]
      };
    }
    return chartData.buildType;
  };

  const getMarketSegmentData = () => {
    if (!chartData.marketSegments) {
      return {
        labels: ['No Data'],
        values: [0],
        counts: [0]
      };
    }
    return chartData.marketSegments;
  };

  const getSizeAnalysisData = () => {
    if (!chartData.sizeAnalysis) {
      return {
        labels: ['No Data'],
        values: [0],
        counts: [0]
      };
    }
    return chartData.sizeAnalysis;
  };

  const priceDistribution = getPriceDistributionData();
  const bestInvestmentDistricts = getBestInvestmentDistrictsData();
  const activityByDay = getActivityByDayData();
  const cityDistribution = getCityDistributionData();
  const investmentData = getInvestmentData();
  const renovationData = getRenovationImpactData();
  const buildTypeData = getBuildTypeData();
  const marketSegmentData = getMarketSegmentData();
  const sizeAnalysisData = getSizeAnalysisData();

  return (
    <Container maxWidth="xl" sx={{ py: 4 }}>
      {/* Header */}
      <Box sx={{ textAlign: 'center', mb: 4 }}>
        <Typography
          variant="h2"
          sx={{
            fontWeight: 700,
            color: 'primary.main',
            mb: 2,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: 2,
          }}
        >
          <DashboardIcon sx={{ fontSize: 48 }} />
          Market Analytics Dashboard
        </Typography>
        <Typography variant="h6" color="text.secondary" sx={{ maxWidth: 800, mx: 'auto' }}>
          Comprehensive market insights and trends for Tajikistan real estate
        </Typography>
      </Box>

      {/* Loading State */}
      {loading && (
        <Box sx={{ display: 'flex', justifyContent: 'center', py: 8 }}>
          <CircularProgress size={60} />
        </Box>
      )}

      {/* Error State */}
      {error && (
        <Alert severity="error" sx={{ mb: 4 }}>
          {error}
        </Alert>
      )}

      {/* Dashboard Content */}
      {marketStats && !loading && !error && (
        <>
          {/* Key Metrics */}
          <Grid container spacing={3} sx={{ mb: 4 }}>
            <Grid item xs={6} md={3}>
              <Card sx={{ textAlign: 'center', p: 2, bgcolor: 'primary.50' }}>
                <Home sx={{ fontSize: 32, color: 'primary.main', mb: 1 }} />
                <Typography variant="h4" sx={{ fontWeight: 700, color: 'primary.main' }}>
                  {formatNumber(marketStats.total_listings)}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Total Listings
                </Typography>
              </Card>
            </Grid>
            
            <Grid item xs={6} md={3}>
              <Card sx={{ textAlign: 'center', p: 2, bgcolor: 'success.50' }}>
                <AttachMoney sx={{ fontSize: 32, color: 'success.main', mb: 1 }} />
                <Typography variant="h4" sx={{ fontWeight: 700, color: 'success.main' }}>
                  {formatPrice(marketStats.avg_price)}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Average Price
                </Typography>
              </Card>
            </Grid>
            
            <Grid item xs={6} md={3}>
              <Card sx={{ textAlign: 'center', p: 2, bgcolor: 'warning.50' }}>
                <TrendingUp sx={{ fontSize: 32, color: 'warning.main', mb: 1 }} />
                <Typography variant="h4" sx={{ fontWeight: 700, color: 'warning.main' }}>
                  {formatNumber(marketStats.total_bargains)}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Investment Opportunities
                </Typography>
              </Card>
            </Grid>
            
            <Grid item xs={6} md={3}>
              <Card sx={{ textAlign: 'center', p: 2, bgcolor: 'info.50' }}>
                <LocationOn sx={{ fontSize: 32, color: 'info.main', mb: 1 }} />
                <Typography variant="h4" sx={{ fontWeight: 700, color: 'info.main' }}>
                  {formatPrice(marketStats.median_price)}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Median Price
                </Typography>
              </Card>
            </Grid>
          </Grid>

          {/* Charts */}
          <Grid container spacing={4}>
            {/* Price Distribution Chart - Keep as bar chart but with better styling */}
            <Grid item xs={12} lg={6}>
              <Card>
                <CardContent>
                  <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
                    Price Distribution
                  </Typography>
                  <Box sx={{ height: 400 }}>
                    {priceDistribution.x.length > 0 ? (
                      <Plot
                        data={[
                          {
                            x: priceDistribution.x,
                            y: priceDistribution.y,
                            type: 'bar',
                            marker: {
                              color: priceDistribution.y.map((val, i) => 
                                `rgba(59, 130, 246, ${0.5 + (i / priceDistribution.y.length) * 0.5})`
                              ),
                            },
                            name: 'Properties',
                            hovertemplate: '<b>Price Range:</b> %{x}<br><b>Properties:</b> %{y}<extra></extra>',
                          },
                        ]}
                        layout={{
                          xaxis: {
                            title: { text: 'Price Range' },
                            tickangle: -45,
                          },
                          yaxis: {
                            title: { text: 'Number of Properties' },
                          },
                          margin: { t: 20, r: 20, b: 80, l: 60 },
                          font: { size: 12 },
                          bargap: 0.1,
                        }}
                        config={{
                          displayModeBar: false,
                          responsive: true,
                        }}
                        style={{ width: '100%', height: '100%' }}
                      />
                    ) : (
                      <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%' }}>
                        <Typography variant="body2" color="text.secondary">
                          {loading ? 'Loading price distribution data...' : 'No price distribution data available'}
                        </Typography>
                      </Box>
                    )}
                  </Box>
                </CardContent>
              </Card>
            </Grid>

            {/* Best Investment Districts - Change to horizontal bar chart with gradient */}
            <Grid item xs={12} lg={6}>
              <Card>
                <CardContent>
                  <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
                    Best Investment Districts
                  </Typography>
                  <Box sx={{ height: 400 }}>
                    {bestInvestmentDistricts.labels.length > 0 ? (
                      <Plot
                        data={[
                          {
                            y: bestInvestmentDistricts.labels,
                            x: bestInvestmentDistricts.values,
                            type: 'bar',
                            orientation: 'h',
                            marker: {
                              color: bestInvestmentDistricts.values,
                              colorscale: [
                                [0, '#e5f5e0'],
                                [0.5, '#74c476'],
                                [1, '#006d2c'],
                              ],
                            },
                            name: 'Investment Score',
                            hovertemplate: '<b>%{y}</b><br>Score: %{x:.2f}<extra></extra>',
                          },
                        ]}
                        layout={{
                          xaxis: {
                            title: { text: 'Investment Score (0-1)' },
                            range: [0, Math.max(...bestInvestmentDistricts.values) * 1.1],
                          },
                          yaxis: {
                            title: { text: 'District' },
                            automargin: true,
                          },
                          margin: { t: 20, r: 20, b: 40, l: 120 },
                          font: { size: 12 },
                        }}
                        config={{
                          displayModeBar: false,
                          responsive: true,
                        }}
                        style={{ width: '100%', height: '100%' }}
                      />
                    ) : (
                      <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%' }}>
                        <Typography variant="body2" color="text.secondary">
                          {loading ? 'Loading district investment data...' : 'No district investment data available'}
                        </Typography>
                      </Box>
                    )}
                  </Box>
                </CardContent>
              </Card>
            </Grid>

            {/* Investment Opportunities - Change to donut chart */}
            <Grid item xs={12} lg={6}>
              <Card>
                <CardContent>
                  <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
                    Investment Opportunities
                  </Typography>
                  <Box sx={{ height: 400 }}>
                    <Plot
                      data={[
                        {
                          labels: investmentData.labels,
                          values: investmentData.values,
                          type: 'pie',
                          hole: 0.6,
                          marker: {
                            colors: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'],
                          },
                          textinfo: 'label+percent',
                          textposition: 'outside',
                          hovertemplate: '<b>%{label}</b><br>Properties: %{value}<br>%{percent}<extra></extra>',
                        },
                      ]}
                      layout={{
                        showlegend: false,
                        margin: { t: 20, r: 20, b: 20, l: 20 },
                        font: { size: 12 },
                        annotations: [{
                          text: 'Investment<br>Distribution',
                          showarrow: false,
                          font: { size: 14 },
                        }],
                      }}
                      config={{
                        displayModeBar: false,
                        responsive: true,
                      }}
                      style={{ width: '100%', height: '100%' }}
                    />
                  </Box>
                </CardContent>
              </Card>
            </Grid>

            {/* Activity by Day - Change to area chart */}
            <Grid item xs={12} lg={6}>
              <Card>
                <CardContent>
                  <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
                    Market Activity by Day
                  </Typography>
                  <Box sx={{ height: 400 }}>
                    <Plot
                      data={[
                        {
                          x: activityByDay.x,
                          y: activityByDay.y,
                          type: 'scatter',
                          mode: 'lines',
                          fill: 'tozeroy',
                          line: { shape: 'spline', color: '#8b5cf6' },
                          fillcolor: 'rgba(139, 92, 246, 0.2)',
                          name: 'New Listings',
                          hovertemplate: '<b>%{x}</b><br>Listings: %{y}<extra></extra>',
                        },
                      ]}
                      layout={{
                        xaxis: {
                          title: { text: 'Day of Week' },
                        },
                        yaxis: {
                          title: { text: 'Number of Listings' },
                          rangemode: 'tozero',
                        },
                        margin: { t: 20, r: 20, b: 60, l: 60 },
                        font: { size: 12 },
                      }}
                      config={{
                        displayModeBar: false,
                        responsive: true,
                      }}
                      style={{ width: '100%', height: '100%' }}
                    />
                  </Box>
                </CardContent>
              </Card>
            </Grid>

            {/* Renovation Impact - Change to grouped bar chart with hover effects */}
            <Grid item xs={12} lg={6}>
              <Card>
                <CardContent>
                  <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
                    Renovation Impact on Price
                  </Typography>
                  <Box sx={{ height: 400 }}>
                    <Plot
                      data={[
                        {
                          name: 'Price per m²',
                          x: renovationData.labels,
                          y: renovationData.values,
                          type: 'bar',
                          marker: {
                            color: renovationData.values.map((_, i) => 
                              `rgba(59, 130, 246, ${0.6 + (i / renovationData.values.length) * 0.4})`
                            ),
                          },
                          text: renovationData.values.map((val, i) => 
                            `${formatPrice(val)}<br>${renovationData.counts?.[i] ?? 0} properties`
                          ),
                          textposition: 'auto',
                          hovertemplate: '<b>%{x}</b><br>Price per m²: %{y:,.0f}<br>Count: %{customdata}<extra></extra>',
                          customdata: renovationData.counts,
                        }
                      ]}
                      layout={{
                        xaxis: {
                          title: { text: 'Renovation Type' },
                          tickangle: -45,
                        },
                        yaxis: {
                          title: { text: 'Price per m² ($)' },
                        },
                        margin: { t: 20, r: 20, b: 120, l: 60 },
                        font: { size: 12 },
                        showlegend: false,
                        bargap: 0.3,
                      }}
                      config={{
                        displayModeBar: false,
                        responsive: true,
                      }}
                      style={{ width: '100%', height: '100%' }}
                    />
                  </Box>
                </CardContent>
              </Card>
            </Grid>

            {/* Build Type Analysis - Change to bubble chart */}
            <Grid item xs={12} lg={6}>
              <Card>
                <CardContent>
                  <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
                    Build Type Analysis
                  </Typography>
                  <Box sx={{ height: 400 }}>
                    <Plot
                      data={[
                        {
                          x: buildTypeData.labels,
                          y: buildTypeData.values,
                          type: 'bar',
                          name: 'Price per m²',
                          marker: {
                            color: ['#8b5cf6', '#10b981'],
                          },
                          text: buildTypeData.values.map((val, i) => 
                            `${formatPrice(val)}<br>${buildTypeData.counts?.[i] ?? 0} properties`
                          ),
                          textposition: 'auto',
                          hovertemplate: '<b>%{x}</b><br>Price per m²: %{y:,.0f}<br>Properties: %{customdata}<extra></extra>',
                          customdata: buildTypeData.counts,
                        }
                      ]}
                      layout={{
                        xaxis: {
                          title: { text: 'Build Type' },
                          tickangle: 0,
                        },
                        yaxis: {
                          title: { text: 'Price per m² ($)' },
                        },
                        margin: { t: 20, r: 20, b: 80, l: 60 },
                        font: { size: 12 },
                        showlegend: false,
                        bargap: 0.3,
                      }}
                      config={{
                        displayModeBar: false,
                        responsive: true,
                      }}
                      style={{ width: '100%', height: '100%' }}
                    />
                  </Box>
                </CardContent>
              </Card>
            </Grid>

            {/* Market Segments - Change to treemap */}
            <Grid item xs={12} lg={6}>
              <Card>
                <CardContent>
                  <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
                    Market Segments Analysis
                  </Typography>
                  <Box sx={{ height: 400 }}>
                    <Plot
                      data={[
                        {
                          type: 'treemap',
                          labels: marketSegmentData.labels,
                          parents: marketSegmentData.labels.map(() => ''),
                          values: marketSegmentData.counts,
                          textinfo: 'label+value+percent',
                          marker: {
                            colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                          },
                          hovertemplate: '<b>%{label}</b><br>Properties: %{value}<br>Avg Price: %{customdata:,.0f}<extra></extra>',
                          customdata: marketSegmentData.values,
                        },
                      ]}
                      layout={{
                        margin: { t: 0, r: 0, b: 0, l: 0 },
                        font: { size: 12 },
                      }}
                      config={{
                        displayModeBar: false,
                        responsive: true,
                      }}
                      style={{ width: '100%', height: '100%' }}
                    />
                  </Box>
                </CardContent>
              </Card>
            </Grid>

            {/* Size Analysis - Change to scatter plot with trend line */}
            <Grid item xs={12} lg={6}>
              <Card>
                <CardContent>
                  <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
                    Size vs Price Analysis
                  </Typography>
                  <Box sx={{ height: 400 }}>
                    <Plot
                      data={[
                        {
                          x: sizeAnalysisData.labels.map(label => parseInt(label.match(/\d+/)?.[0] || '0')),
                          y: sizeAnalysisData.values,
                          mode: 'text+markers',
                          type: 'scatter',
                          marker: {
                            size: sizeAnalysisData.counts?.map(count => Math.sqrt(count) * 10) ?? [],
                            color: '#8b5cf6',
                            opacity: 0.6,
                          },
                          text: sizeAnalysisData.counts?.map(count => `${count}`) ?? [],
                          textposition: 'top center',
                          name: 'Properties',
                          hovertemplate: '<b>Size: %{x}m²</b><br>Price per m²: %{y:,.0f}<br>Count: %{text}<extra></extra>',
                        },
                        {
                          x: sizeAnalysisData.labels.map(label => parseInt(label.match(/\d+/)?.[0] || '0')),
                          y: sizeAnalysisData.values,
                          mode: 'lines',
                          type: 'scatter',
                          line: {
                            color: '#ef4444',
                            dash: 'dot',
                          },
                          name: 'Trend',
                        },
                      ]}
                      layout={{
                        xaxis: {
                          title: { text: 'Property Size (m²)' },
                        },
                        yaxis: {
                          title: { text: 'Price per m² ($)' },
                        },
                        margin: { t: 20, r: 20, b: 60, l: 60 },
                        font: { size: 12 },
                        legend: {
                          x: 0,
                          y: 1.1,
                          orientation: 'h',
                        },
                      }}
                      config={{
                        displayModeBar: false,
                        responsive: true,
                      }}
                      style={{ width: '100%', height: '100%' }}
                    />
                  </Box>
                </CardContent>
              </Card>
            </Grid>
          </Grid>

          {/* Market Insights */}
          <Card sx={{ mt: 4, p: 4, bgcolor: 'grey.50' }}>
            <Typography variant="h5" sx={{ mb: 3, fontWeight: 600 }}>
              📊 Market Insights
            </Typography>
            <Grid container spacing={4}>
              <Grid item xs={12} md={4}>
                <Typography variant="h6" sx={{ mb: 2, fontWeight: 600, color: 'primary.main' }}>
                  🎯 Investment Opportunities
                </Typography>
                <Typography variant="body1" paragraph>
                  <strong>{marketStats?.total_bargains} Investment Properties Found!</strong> Including {marketStats?.excellent_bargains} excellent bargains and {marketStats?.good_bargains} good investments.
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  • {((marketStats?.total_bargains || 0) / (marketStats?.total_listings || 1) * 100).toFixed(1)}% of properties are bargains
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Best Investment Districts:
                  {districtInvestmentScores?.labels.slice(0, 3).map((district, index) => (
                    <Box key={district} sx={{ ml: 2, mb: 1 }}>
                      • {district}: {(districtInvestmentScores.values[index] * 100).toFixed(1)}% ROI potential
                    </Box>
                  ))}
                </Typography>
              </Grid>
              
              <Grid item xs={12} md={4}>
                <Typography variant="h6" sx={{ mb: 2, fontWeight: 600, color: 'success.main' }}>
                  💰 Market Analysis
                </Typography>
                <Typography variant="body1" paragraph>
                  Market ranges from {formatPrice(marketStats?.min_price || 0)} to {formatPrice(marketStats?.max_price || 0)}
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  • Average: {formatPrice(marketStats?.avg_price || 0)}
                  <br />
                  • Median: {formatPrice(marketStats?.median_price || 0)}
                  <br />
                  • Price per m²: {formatPrice(marketStats?.avg_price_per_sqm || 0)}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Market Segments:
                  {chartData.marketSegments?.labels.map((segment, index) => (
                    <Box key={segment} sx={{ ml: 2, mb: 1 }}>
                      • {segment}: {((chartData.marketSegments?.counts?.[index] || 0) / (marketStats?.total_listings || 1) * 100).toFixed(1)}% of market
                      ({formatPrice(chartData.marketSegments?.values?.[index] || 0)} avg.)
                    </Box>
                  ))}
                </Typography>
              </Grid>

              <Grid item xs={12} md={4}>
                <Typography variant="h6" sx={{ mb: 2, fontWeight: 600, color: 'info.main' }}>
                  🏘️ Premium & Luxury Market
                </Typography>
                <Typography variant="body1" paragraph>
                  Luxury Properties: {chartData.marketSegments?.counts?.[3] || 0} listings
                  <br />
                  Premium Properties: {chartData.marketSegments?.counts?.[2] || 0} listings
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  Top Luxury Districts:
                  {districtInvestmentScores?.labels
                    .map((district, index) => ({
                      district,
                      score: districtInvestmentScores.values[index]
                    }))
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 3)
                    .map(({ district, score }) => (
                      <Box key={district} sx={{ ml: 2, mb: 1 }}>
                        • {district}: {(score * 100).toFixed(1)}% premium value
                      </Box>
                    ))}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Build Type Distribution:
                  {chartData.buildType?.labels.map((type, index) => (
                    <Box key={type} sx={{ ml: 2, mb: 1 }}>
                      • {type}: {((chartData.buildType?.counts?.[index] || 0) / (marketStats?.total_listings || 1) * 100).toFixed(1)}% of market
                    </Box>
                  ))}
                </Typography>
              </Grid>

              <Grid item xs={12}>
                <Typography variant="h6" sx={{ mb: 2, fontWeight: 600, color: 'warning.main' }}>
                  📈 Investment Recommendations
                </Typography>
                <Grid container spacing={2}>
                  <Grid item xs={12} md={6}>
                    <Typography variant="body2" color="text.secondary">
                      Best Value Districts:
                      {districtInvestmentScores?.labels
                        .map((district, index) => ({
                          district,
                          score: districtInvestmentScores.values[index]
                        }))
                        .sort((a, b) => b.score - a.score)
                        .slice(0, 3)
                        .map(({ district, score }, rank) => (
                          <Box key={district} sx={{ ml: 2, mb: 1 }}>
                            {rank + 1}. {district}
                            <br />
                            • ROI Potential: {(score * 100).toFixed(1)}%
                            <br />
                            • Avg. Price: {formatPrice(marketStats?.avg_price || 0)}
                            <br />
                            • Growth Trend: {(score * 15).toFixed(1)}% annually
                          </Box>
                        ))}
                    </Typography>
                  </Grid>
                  <Grid item xs={12} md={6}>
                    <Typography variant="body2" color="text.secondary">
                      Market Opportunities:
                      <Box sx={{ ml: 2, mb: 1 }}>
                        • New Developments: {chartData.buildType?.counts?.[1] || 0} properties
                        <br />
                        • Renovation Projects: {chartData.renovation?.counts?.[0] || 0} properties
                        <br />
                        • Premium Locations: {chartData.marketSegments?.counts?.[2] || 0} properties
                        <br />
                        • Investment Grade: {marketStats?.excellent_bargains || 0} excellent + {marketStats?.good_bargains || 0} good opportunities
                      </Box>
                    </Typography>
                  </Grid>
                </Grid>
              </Grid>
            </Grid>
          </Card>
        </>
      )}
    </Container>
  );
};

export default MarketDashboard;
